<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authenticating... - FocuzNow</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            background-color: #0f172a;
            color: #f8fafc;
            font-family: system-ui, -apple-system, sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }

        .loader {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid #6366f1;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div class="loader"></div>
    <p id="status">Finishing login...</p>

    <script>
        // Initialize Supabase - Replace with your actual credentials
        const SUPABASE_URL = 'https://ygxyipegcwhiyirxvfli.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlneHlpcGVnY3doaXlpcnh2ZmxpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE3Mjc2NTEsImV4cCI6MjA3NzMwMzY1MX0.FTu9FDpGJylYurzylZkZC3asMz16ekUtLuoxjSSQQfk';
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        async function handleAuth() {
            // Supabase automatically handles the hash fragment parsing
            const { data: { session }, error } = await supabase.auth.getSession();

            if (error) {
                document.getElementById('status').textContent = 'Login failed: ' + error.message;
                document.getElementById('status').style.color = '#ef4444';
                return;
            }

            if (session) {
                // Post message to extension
                window.postMessage({
                    type: 'FZ_LOGIN_SUCCESS',
                    token: session.access_token,
                    refreshToken: session.refresh_token,
                    user: session.user
                }, '*');

                document.getElementById('status').textContent = 'âœ¨ Login successful! You can close this tab.';

                // Optional: Redirect to dashboard or close
                // window.close();
            } else {
                // No session found, maybe redirect back to login
                window.location.href = '/login';
            }
        }

        // Listen for auth state changes (handles the redirect callback)
        supabase.auth.onAuthStateChange((event, session) => {
            if (event === 'SIGNED_IN' && session) {
                handleAuth();
            }
        });

        // Initial check
        handleAuth();
    </script>
</body>

</html>
